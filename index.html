<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”æ—¥å ±è¡¨äº’å‹•æ•™å­¸ç³»çµ± v3.1</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --plus-color: #27ae60;
            --minus-color: #c0392b;
            --result-bg: #fdf2e9;
            --drag-highlight: #e8f8f5;
            --drag-border: #1abc9c;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            display: flex;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        /* å·¦å´ï¼šå ±è¡¨å€ */
        .report-container {
            flex: 3; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed; 
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top; /* æ”¹ç‚ºé ä¸Šå°é½Šï¼Œé…åˆå¤šè¡Œå‚™è¨» */
            word-wrap: break-word;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* --- ç‰ˆé¢å¯¬åº¦è¨­å®š --- */
        .col-name { width: 25%; }
        .col-box { width: 40%; }
        .col-amount { width: 10%; }
        .col-note { width: 25%; }

        .item-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
            padding-top: 5px;
        }

        .indent-1 { padding-left: 15px; font-size: 0.85em; color: #555; }
        .indent-2 { padding-left: 30px; font-size: 0.85em; color: #777; }

        .sign-plus { color: var(--plus-color); font-weight: bold; }
        .sign-minus { color: var(--minus-color); font-weight: bold; }

        .result-row {
            background-color: var(--result-bg);
            font-weight: bold;
            font-size: 1.1em;
            border-top: 2px solid #333;
        }

        .amount-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            padding-top: 5px;
        }

        /* æ–¹æ¡†å®¹å™¨ */
        .box-container {
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            transition: background 0.2s, border 0.2s;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 2px;
        }

        .box-container.drag-over {
            background-color: var(--drag-highlight);
            border: 2px dashed var(--drag-border);
        }

        /* æ–¹æ¡†æ¨£å¼ */
        .data-box {
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: grab;
            display: inline-flex;
            align-items: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            user-select: none;
            white-space: nowrap; 
            margin-bottom: 2px;
        }
        
        .data-box:active { cursor: grabbing; }
        .data-box:hover { background-color: #2980b9; }

        .data-box .remove-btn {
            margin-left: 6px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            border-left: 1px solid rgba(255,255,255,0.3);
            padding-left: 6px;
        }
        .data-box .remove-btn:hover { opacity: 1; }

        /* --- å‚™è¨»æ¬„æ¨£å¼ (ä¿®æ”¹ç‚º Textarea) --- */
        .note-input {
            width: 95%;
            border: 1px solid transparent; /* å¹³å¸¸éš±è—é‚Šæ¡† */
            border-bottom: 1px dashed #ccc;
            background: transparent;
            outline: none;
            color: #444;
            font-size: 0.9em;
            font-family: inherit;
            resize: vertical; /* å…è¨±å‚ç›´æ‹‰ä¼¸ */
            min-height: 3em;  /* é è¨­é«˜åº¦ */
            line-height: 1.4;
            padding: 2px;
            box-sizing: border-box;
        }
        .note-input:focus {
            border: 1px solid var(--accent-color);
            background-color: #fff;
            color: #000;
            border-radius: 4px;
        }

        /* å³å´ï¼šæ§åˆ¶å€ */
        .control-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: fit-content;
        }

        h2, h3 { margin-top: 0; color: var(--primary-color); }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 0.9em; }
        
        input, select, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            background-color: var(--plus-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: bold;
        }
        button:hover { background-color: #219150; }
        
        .reset-btn { background-color: var(--minus-color); margin-top: 10px; }
        .reset-btn:hover { background-color: #a93226; }

        .tutorial-note {
            background-color: #e8f6f3;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid var(--accent-color);
            font-size: 0.9em;
            line-height: 1.5;
        }
    </style>
</head>
<body>

    <div class="report-container">
        <h2>ğŸ“… äº”æ—¥å ±è¡¨ (äº’å‹•æ•™å­¸ v3.1)</h2>
        <table id="reportTable">
            <thead>
                <tr>
                    <th class="col-name">é …ç›®åç¨±</th>
                    <th class="col-box">é‡‘é¡ä¾†æº(åç›®)</th>
                    <th class="col-amount">å°è¨ˆ</th>
                    <th class="col-note">å‚™è¨» (è‡ªå‹•æ›è¡Œ)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <div class="control-panel">
        <h3>ğŸ› ï¸ æ–°å¢æ–¹æ¡†</h3>
        <div class="tutorial-note">
            <p><strong>åŠŸèƒ½èªªæ˜ï¼š</strong></p>
            1. <strong>é è¨­è³‡æ–™</strong>ï¼šç³»çµ±å·²è‡ªå‹•è¼‰å…¥éƒ¨åˆ†é …ç›®ä¾›æ•™å­¸æ¼”ç¤ºã€‚<br>
            2. <strong>æ‹–æ›³ä¿®æ­£</strong>ï¼šè©¦è‘—æŠŠã€Œäº”Då ±è¡¨ã€çš„æ–¹æ¡†æ‹–åˆ°å…¶ä»–åˆ—ã€‚<br>
            3. <strong>å‚™è¨»ç·¨è¼¯</strong>ï¼šå·²æ”¹ç‚ºè‡ªå‹•æ›è¡Œï¼Œè‹¥æ–‡å­—éé•·å¯æ‹‰å‹•å³ä¸‹è§’èª¿æ•´é«˜åº¦ã€‚
        </div>

        <div class="input-group">
            <label>æ–¹æ¡†åç¨± (åç›®)</label>
            <input type="text" id="inputName" placeholder="ä¾‹å¦‚ï¼šé™³å°å§ç¹³æ°´è²»">
        </div>

        <div class="input-group">
            <label>é‡‘é¡</label>
            <input type="number" id="inputAmount" placeholder="è¼¸å…¥é‡‘é¡" min="0">
        </div>

        <div class="input-group">
            <label>æ­¸å±¬é …ç›®</label>
            <select id="inputCategory">
                </select>
        </div>

        <button onclick="addBox()">â• æ–°å¢æ–¹æ¡†</button>
        <button class="reset-btn" onclick="resetAll()">âš ï¸ æ¢å¾©é è¨­å€¼</button>
    </div>

<script>
    // --- 1. å ±è¡¨å®šç¾©èˆ‡é è¨­å‚™è¨» ---
    const reportStructure = [
        { id: '1', name: '1. äº”Då ±è¡¨', sign: 1, type: 'input', level: 0, defaultNote: 'ç³»çµ±ä»Šæ—¥æ‰€æœ‰éŠ·å¸³' },
        { id: '2', name: '2. å¡4', sign: -1, type: 'input', level: 0 },
        { id: '2.1', name: '2.1 å¼·åˆ¶é‚„åŸ', sign: -1, type: 'input', level: 1 },
        { id: '2.2', name: '2.2 ç™¼ç¥¨æŠ˜è®“', sign: -1, type: 'input', level: 1 },
        { id: '3', name: '3. ä¿è­‰é‡‘', sign: -1, type: 'input', level: 0 },
        { id: '3.1', name: '3.1 è‡¨æ™‚ç”¨æ°´ä¿è­‰é‡‘', sign: -1, type: 'input', level: 1 },
        { id: '3.2', name: '3.2 å»¶ç®¡å·¥ç¨‹ä¿è­‰é‡‘', sign: -1, type: 'input', level: 1 },
        { id: '4', name: '4. å­˜ç°¿åˆ©æ¯æ”¶å…¥', sign: 1, type: 'input', level: 0 },
        
        { id: '5', name: '5. æœ¬æ—¥æ‡‰å…¥å¸³é‡‘é¡', sign: 0, type: 'calc', level: 0, defaultNote: 'æ ¸å°OK' }, 
        
        { id: '6', name: '6. çµ±ä¸€å½™ç¹³', sign: -1, type: 'input', level: 0 },
        { id: '7', name: '7. åª’é«”ä»£ç¹³', sign: -1, type: 'input', level: 0, defaultNote: 'ä»£ç¹³è‡ªå‹•ã€å…¥å¸³ã€‘ï¼Œè¡¨ç¤ºéŠ€è¡ŒæœƒåŒ¯éŒ¢' },
        { id: '8', name: '8. åª’é«”ä»£æ”¶', sign: -1, type: 'input', level: 0 },
        { id: '9', name: '9. ä¿¡ç”¨å¡ç¹³è²»å¹³å°', sign: -1, type: 'input', level: 0 },
        { id: '10_up', name: '10. éåª’é«”ä»£æ”¶ç¹³å…¥å€è™•', sign: -1, type: 'input', level: 0 },
        { id: '11', name: '11. æ‰‹çºŒè²»', sign: -1, type: 'input', level: 0 },
        { id: '12', name: '12. åŒ¯æ¬¾ç¹³è²»å…¥å€è™•', sign: -1, type: 'input', level: 0 ,defaultNote: 'ã€äººå·¥å·²éŠ·å¸³ã€‘ï¼ŒéŒ¢ä¾†è‡ªã€ä¸€å€ã€‘åˆåº«15151ã€‚ç‰¹æ®ŠVIPæˆ–ã€ç•°å¸¸å ±è¡¨ã€‘éœ€äººå·¥è™•ç†'},
        { id: '13_up', name: '13. åŒ¯æ¬¾ç¹³è²»å…¥æœ¬æ‰€', sign: -1, type: 'input', level: 0 },
        { id: '14_local', name: '14. ä»–å€ä»£æ”¶ (æœ¬å€)', sign: -1, type: 'input', level: 0 , defaultNote: 'éŒ¢åœ¨ã€ä½ å®¶ã€‘=ã€åˆ¥å€ã€‘'},
        { id: '14_other', name: '14. ä»–å€ä»£æ”¶ (ä»–å€)', sign: -1, type: 'input', level: 1 },
        { id: '15_local', name: '15. ä»£æ”¶ä»–å€ (æœ¬å€)', sign: 1, type: 'input', level: 0 , defaultNote: 'éŒ¢åœ¨ã€æˆ‘å®¶ã€‘=ã€1å€ã€‘'},
        { id: '15_other', name: '15. ä»£æ”¶ä»–å€ (ä»–å€)', sign: 1, type: 'input', level: 1 },
        { id: '16', name: '16. æœ¬æœˆé æ”¶æ¬¡æœˆæ°´è²»', sign: 1, type: 'input', level: 0 },
        { id: '17', name: '17. æœ¬æœˆæ‰£æŠµä¸Šæœˆé æ”¶', sign: -1, type: 'input', level: 0 },
        { id: '28.1', name: '28.1 ä¿¡ç”¨å¡é€€è²¨(é‚„åŸ)', sign: 1, type: 'input', level: 0 },

        { id: '18', name: '18. æœ¬æ—¥æ«ƒå°æ‡‰ç¹³é‡‘é¡', sign: 0, type: 'calc', level: 0 },

        { id: '10_down', name: '10. éåª’é«”ä»£æ”¶ç¹³å…¥æœ¬æ‰€', sign: -1, type: 'input', level: 0 },
        { id: '13_down', name: '13. åŒ¯æ¬¾ç¹³è²»å…¥æœ¬æ‰€(+)', sign: 1, type: 'input', level: 0 },
        { id: '19', name: '19. ä»–æ‰€ä»£æ”¶åŒ¯æ¬¾å…¥æœ¬æ‰€', sign: 1, type: 'input', level: 0 },
        { id: '28_down', name: '28. è‡¨æ«ƒä¿¡ç”¨å¡åŒ¯å…¥å€è™•', sign: -1, type: 'input', level: 0 , defaultNote: 'è¯å¡ä¸­å¿ƒæ˜æ—¥æœƒåŒ¯éŒ¢(=å€è™•15151)'},

        { id: '20', name: '20. æœ¬æ‰€æ‡‰åŒ¯æ¬¾é‡‘é¡', sign: 0, type: 'calc', level: 0 },

        { id: '21', name: '21. æ”¯ç¥¨å·²å…Œé‡‘é¡', sign: 1, type: 'input', level: 0 },
        { id: '22', name: '22. æ”¯ç¥¨æœªå…Œé‡‘é¡', sign: -1, type: 'input', level: 0 },

        { id: '23', name: '23. æœ¬æ—¥åŒ¯æ¬¾å–®åˆè¨ˆ', sign: 0, type: 'calc', level: 0, defaultNote: 'ã€â˜…é‡è¦ã€‘å» æ‰€éœ€è¦è§£ç¹³(=åŒ¯åˆ°å€è™•15151)çš„éŒ¢' }
    ];

    // --- é è¨­æ–¹æ¡†è³‡æ–™ ---
    const defaultBoxData = [
        { categoryId: '1', name: 'è‡¨æ«ƒæ”¶é‡‘', amount: 12000 },
        { categoryId: '1', name: 'ä»£æ”¶ç¹³è‡ªå‹•éŠ·å¸³', amount: 3500 },
        { categoryId: '1', name: 'HYè‡ªå‹•éŠ·å¸³', amount: 800 },
	  { categoryId: '1', name: 'ä»Šæ—¥ç”¨æˆ¶æ«ƒå°ä¿¡ç”¨å¡åˆ·å¡', amount: 1000 },
        { categoryId: '7', name: 'ä»£æ”¶ç¹³è‡ªå‹•å…¥å¸³', amount: 3500 },
        { categoryId: '7', name: 'HYè‡ªå‹•éŠ·å¸³', amount: 800 },
        { categoryId: '28_down', name: 'ä»Šæ—¥ç”¨æˆ¶åˆ·å¡', amount: 1000 }
    ];

    let itemTotals = {}; 
    let itemBoxes = {};

    function init() {
        const tbody = document.getElementById('tableBody');
        const select = document.getElementById('inputCategory');
        tbody.innerHTML = '';
        select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é …ç›®...</option>';

        itemBoxes = {};
        reportStructure.forEach(item => {
            itemTotals[item.id] = 0;
            itemBoxes[item.id] = [];
        });

        defaultBoxData.forEach(data => {
            itemBoxes[data.categoryId].push({
                id: Date.now() + Math.random(), 
                name: data.name,
                amount: data.amount
            });
        });

        reportStructure.forEach(item => {
            const tr = document.createElement('tr');
            if(item.type === 'calc') tr.classList.add('result-row');

            let nameHtml = `<div class="${item.level === 1 ? 'indent-1' : ''} ${item.level === 2 ? 'indent-2' : ''}">${item.name}</div>`;
            if (item.sign === 1) nameHtml += ` <span class="sign-plus">(+)</span>`;
            if (item.sign === -1) nameHtml += ` <span class="sign-minus">(-)</span>`;
            
            let boxHtml = '';
            if (item.type === 'input') {
                boxHtml = `<div class="box-container" id="box-container-${item.id}" 
                            ondragover="allowDrop(event)" 
                            ondragleave="leaveDrop(event)"
                            ondrop="drop(event, '${item.id}')"></div>`;
            } else {
                boxHtml = `<div style="color:#ccc; font-size:12px;"></div>`;
            }

            let amountHtml = `<div id="amount-${item.id}" class="amount-cell">0</div>`;

            // ä¿®æ”¹é»: æ”¹ç”¨ textarea å¯¦ç¾è‡ªå‹•æ›è¡Œ
            const defaultText = item.defaultNote ? item.defaultNote : '';
            let noteHtml = `<textarea class="note-input" placeholder="...">${defaultText}</textarea>`;

            tr.innerHTML = `
                <td class="item-name">${nameHtml}</td>
                <td>${boxHtml}</td>
                <td>${amountHtml}</td>
                <td>${noteHtml}</td>
            `;
            tbody.appendChild(tr);

            if(item.type === 'input') {
                const option = document.createElement('option');
                option.value = item.id;
                option.text = item.name + (item.sign === 1 ? ' (+)' : ' (-)');
                select.appendChild(option);
            }
        });

        Object.keys(itemBoxes).forEach(id => renderBoxes(id));
    }

    // --- é‚è¼¯éƒ¨åˆ†ç¶­æŒä¸è®Š ---

    function addBox() {
        const name = document.getElementById('inputName').value;
        const amount = parseFloat(document.getElementById('inputAmount').value);
        const categoryId = document.getElementById('inputCategory').value;

        if (!name || isNaN(amount) || !categoryId) {
            alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');
            return;
        }

        itemBoxes[categoryId].push({ 
            id: Date.now(), 
            name, 
            amount 
        });

        renderBoxes(categoryId);
        calculate();

        document.getElementById('inputName').value = '';
        document.getElementById('inputAmount').value = '';
    }

    function removeBox(categoryId, boxId) {
        itemBoxes[categoryId] = itemBoxes[categoryId].filter(b => b.id !== boxId);
        renderBoxes(categoryId);
        calculate();
    }

    function drag(ev, categoryId, boxId) {
        const data = JSON.stringify({ sourceCategory: categoryId, boxId: boxId });
        ev.dataTransfer.setData("text", data);
        ev.dataTransfer.effectAllowed = "move";
    }

    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    function leaveDrop(ev) {
        ev.currentTarget.classList.remove('drag-over');
    }

    function drop(ev, targetCategory) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');

        const dataStr = ev.dataTransfer.getData("text");
        if (!dataStr) return;
        
        const data = JSON.parse(dataStr);
        const sourceCategory = data.sourceCategory;
        const boxId = data.boxId;

        if (sourceCategory === targetCategory) return;

        const boxIndex = itemBoxes[sourceCategory].findIndex(b => b.id === boxId);
        if (boxIndex === -1) return;
        const boxData = itemBoxes[sourceCategory][boxIndex];

        itemBoxes[sourceCategory].splice(boxIndex, 1);
        itemBoxes[targetCategory].push(boxData);

        renderBoxes(sourceCategory);
        renderBoxes(targetCategory);
        calculate();
    }

    function renderBoxes(id) {
        const container = document.getElementById(`box-container-${id}`);
        if(!container) return;
        container.innerHTML = '';
        
        let sum = 0;
        itemBoxes[id].forEach((box) => {
            sum += box.amount;
            const boxEl = document.createElement('div');
            boxEl.className = 'data-box';
            boxEl.draggable = true;
            boxEl.ondragstart = (event) => drag(event, id, box.id);
            
            boxEl.innerHTML = `
                ${box.name}: ${box.amount}
                <span class="remove-btn" onclick="removeBox('${id}', ${box.id})">Ã—</span>
            `;
            container.appendChild(boxEl);
        });

        itemTotals[id] = sum;
        
        const sign = reportStructure.find(i => i.id === id).sign;
        const amountEl = document.getElementById(`amount-${id}`);
        amountEl.innerText = (sum * sign);
        amountEl.style.color = sign === 1 ? 'var(--plus-color)' : 'var(--minus-color)';
    }

    function calculate() {
        const val = (id) => {
            const item = reportStructure.find(i => i.id === id);
            if (!item) return 0;
            if (item.type === 'calc') return itemTotals[id] || 0;
            return (itemTotals[id] || 0) * item.sign;
        };

        let total5 = val('1') + val('2') + val('2.1') + val('2.2') + val('3') + val('3.1') + val('3.2') + val('4');
        updateResultRow('5', total5);

        let adjustTo18 = 
            val('6') + val('7') + val('8') + val('9') + val('10_up') + 
            val('11') + val('12') + val('13_up') + val('14_local') + val('14_other') + 
            val('15_local') + val('15_other') + val('16') + val('17') + val('28.1');
        let total18 = total5 + adjustTo18;
        updateResultRow('18', total18);

        let adjustTo20 = val('10_down') + val('13_down') + val('19') + val('28_down');
        let total20 = total18 + adjustTo20;
        updateResultRow('20', total20);

        let total23 = total20 + val('21') + val('22');
        updateResultRow('23', total23);
    }

    function updateResultRow(id, value) {
        itemTotals[id] = value;
        const el = document.getElementById(`amount-${id}`);
        el.innerText = value;
        el.style.color = value >= 0 ? 'blue' : 'red';
    }

    function resetAll() {
        if(confirm('ç¢ºå®šè¦æ¢å¾©æˆé è¨­ç‹€æ…‹å—ï¼Ÿ(æ–°å¢çš„è³‡æ–™æœƒæ¶ˆå¤±)')) {
            init();
            calculate();
        }
    }

    init();
    calculate();
</script>
</body>
</html>
