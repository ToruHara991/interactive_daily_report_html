<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”æ—¥å ±è¡¨äº’å‹•æ•™å­¸ç³»çµ± v3.6 (è‡ªå‹•åŠ ç¸½å„ªåŒ–ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db; /* è—è‰² (æ­£é …) */
            --bg-color: #f4f7f6;
            --plus-color: #27ae60;
            --minus-color: #c0392b; /* ç´…è‰² (è² é …) */
            --result-bg: #fdf2e9;
            --drag-highlight: #e8f8f5;
            --drag-border: #1abc9c;
            --sidebar-width: 320px;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            height: 100vh;
            overflow-x: hidden;
        }

        /* --- å ±è¡¨å€ --- */
        .report-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            padding-bottom: 90px; 
            box-sizing: border-box;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        h2 {
            margin-top: 10px;
            font-size: 1.5rem;
            text-align: center;
            color: var(--primary-color);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 600px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            white-space: nowrap;
        }

        .col-name { width: 25%; min-width: 120px; }
        .col-box { width: 40%; min-width: 180px; }
        .col-amount { width: 10%; min-width: 80px; }
        .col-note { width: 25%; min-width: 120px; }

        .item-name { font-weight: bold; color: #333; font-size: 0.9em; padding-top: 5px; }
        .indent-1 { padding-left: 15px; font-size: 0.85em; color: #555; }
        .indent-2 { padding-left: 30px; font-size: 0.85em; color: #777; }
        .sign-plus { color: var(--plus-color); font-weight: bold; }
        .sign-minus { color: var(--minus-color); font-weight: bold; }

        .result-row {
            background-color: var(--result-bg);
            font-weight: bold;
            font-size: 1.1em;
            border-top: 2px solid #333;
        }

        /* --- [æ–°å¢] ç‰¹æ®Šç¶²åº•æ¨£å¼ --- */
        .row-locked {
            background-color: #eeeeee; /* æ·ºç°è‰²ï¼šç”¨æ–¼ 2 å’Œ 3 (é–æ­») */
            color: #555;
        }
        .row-highlight {
            background-color: #fffcf0; /* æ·ºé»ƒè‰²ï¼šç”¨æ–¼ 14 å’Œ 15 */
        }

        .amount-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            padding-top: 5px;
            font-weight: bold;
        }

        /* --- æ–¹æ¡†æ¨£å¼ --- */
        .box-container {
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            padding: 2px;
            border: 2px solid transparent;
            border-radius: 4px;
        }

        .box-container.drag-over {
            background-color: var(--drag-highlight);
            border: 2px dashed var(--drag-border);
        }

        /* é è¨­æ–¹æ¡† (è—è‰²) */
        .data-box {
            background-color: var(--accent-color);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            cursor: grab;
            display: inline-flex;
            align-items: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            margin-bottom: 2px;
            user-select: none;
            transition: background-color 0.2s;
        }

        .data-box:hover {
            background-color: #2980b9;
        }
        
        /* è² é …æ–¹æ¡† (ç´…è‰²) */
        .data-box.minus {
            background-color: var(--minus-color);
        }

        .data-box.minus:hover {
            background-color: #a93226;
        }
        
        .data-box:active { cursor: grabbing; }
        
        .data-box .remove-btn {
            margin-left: 8px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            border-left: 1px solid rgba(255,255,255,0.4);
            padding-left: 8px;
            font-size: 14px;
        }

        /* --- å‚™è¨»æ¬„ (æ”¯æ´ HTML é¡è‰²) --- */
        .note-input {
            width: 100%;
            min-height: 3em;
            padding: 4px;
            border-bottom: 1px dashed #ccc;
            outline: none;
            font-size: 0.9em;
            line-height: 1.4;
            color: #444;
            background: transparent;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .note-input:focus {
            border: 1px solid var(--accent-color);
            background: #fff;
            color: #000;
            border-radius: 4px;
        }

        /* --- å´é‚Šæ¬„ --- */
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 900;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .control-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: var(--sidebar-width);
            max-width: 85%;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .control-panel.active { right: 0; }

        /* --- æ‡¸æµ®æŒ‰éˆ• (FAB) --- */
        .fab-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 950;
            border: none;
            transition: transform 0.2s;
        }

        .fab-btn:hover { transform: scale(1.05); background-color: #2980b9; }

        /* --- æ°¸ä¹…è·³å‹•å‹•ç•« --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); transform: scale(1); }
            50% { transform: scale(1.05); }
            70% { box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); transform: scale(1); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); transform: scale(1); }
        }
        
        .hint-pulse { 
            animation: pulse 2s infinite; 
        }

        /* æŒ‰éˆ•æ—çš„æ–‡å­—æ¨™ç±¤ (æ°¸ä¹…é¡¯ç¤º) */
        .fab-label {
            position: absolute;
            right: 70px;
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
            opacity: 0.9;
        }
        .fab-label::after {
            content: '';
            position: absolute;
            top: 50%; right: -6px;
            margin-top: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent transparent #e74c3c;
        }

        .close-sidebar-btn {
            align-self: flex-end;
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            margin-bottom: 10px;
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        label { font-weight: bold; font-size: 0.95em; color: #555; }
        
        input, select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .action-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--plus-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .reset-btn { background-color: var(--minus-color); }
        
        .tutorial-note {
            background-color: #e8f6f3;
            padding: 15px;
            border-radius: 6px;
            border-left: 5px solid var(--accent-color);
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 20px;
        }
    .footer {
      background: #2c5aa0;
      color: white;
      margin-top: 50px;
      padding: 25px 0;
      text-align: center;
    }

    .footer-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer p {
      margin: 5px 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .footer p:first-child {
      font-weight: 500;
      margin-bottom: 8px;
    }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <button class="fab-btn hint-pulse" onclick="toggleSidebar()" id="fabBtn">
        ğŸ› ï¸
        <div class="fab-label" id="fabLabel">é»æˆ‘æ–°å¢é …ç›®</div>
    </button>

    <div class="report-container">
        <h2>ğŸ“… äº”æ—¥å ±è¡¨ (äº’å‹•æ•™å­¸ v3.6)</h2>
        <div class="table-responsive">
            <table id="reportTable">
                <thead>
                    <tr>
                        <th class="col-name">é …ç›®åç¨±</th>
                        <th class="col-box">é‡‘é¡ä¾†æº(åç›®)</th>
                        <th class="col-amount">å°è¨ˆ</th>
                        <th class="col-note">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="control-panel" id="sidebar">
        <button class="close-sidebar-btn" onclick="toggleSidebar()">âœ•</button>
        
        <h3>ğŸ› ï¸ æ–°å¢æ–¹æ¡†</h3>
        <div class="tutorial-note">
            <p><strong>åŠŸèƒ½èªªæ˜ï¼š</strong></p>
            1. <strong>äº’å‹•æ“ä½œ</strong>ï¼šç”±æ­¤è™•æ–°å¢é‡‘é¡æ–¹æ¡†ã€‚<br>
            2. <strong>é¡è‰²å€åˆ†</strong>ï¼š<span style="color:var(--accent-color); font-weight:bold;">è—è‰²ç‚ºåŠ é …</span>ï¼Œ<span style="color:var(--minus-color); font-weight:bold;">ç´…è‰²ç‚ºæ¸›é …</span>ã€‚<br>
            3. <strong>è‡ªå‹•é–å®š</strong>ï¼šé …ç›®2å’Œ3ç‚ºè‡ªå‹•è¨ˆç®—ï¼Œä¸å¯æ‰‹å‹•æ–°å¢ã€‚
        </div>

        <div class="input-group">
            <label>æ–¹æ¡†åç¨± (åç›®)</label>
            <input type="text" id="inputName" placeholder="ä¾‹å¦‚ï¼šé™³å°å§ç¹³æ°´è²»">
        </div>

        <div class="input-group">
            <label>é‡‘é¡</label>
            <input type="number" id="inputAmount" placeholder="è¼¸å…¥é‡‘é¡" min="0" inputmode="numeric">
        </div>

        <div class="input-group">
            <label>æ­¸å±¬é …ç›®</label>
            <select id="inputCategory"></select>
        </div>

        <button class="action-btn" onclick="addBox()">â• æ–°å¢æ–¹æ¡†</button>
        <button class="action-btn reset-btn" onclick="resetAll()">âš ï¸ æ¢å¾©é è¨­å€¼</button>
    </div>

<script>
    /* --- å ±è¡¨å®šç¾© --- */
    /* ä¿®æ”¹èªªæ˜ï¼š
       1. å°‡ id: '2' å’Œ id: '3' çš„ type æ”¹ç‚º 'summary' (è‡ªå®šç¾©é¡å‹)ï¼Œ
          è¡¨ç¤ºé€™å…©é …ä¸å†æ˜¯è¼¸å…¥é …ï¼Œè€Œæ˜¯ç´”ç²¹çš„é¡¯ç¤º/è¨ˆç®—é …ã€‚
       2. ç§»é™¤äº† defaultNoteï¼Œè®“å®ƒæ›´ä¹¾æ·¨ï¼Œæˆ–è€…æ‚¨å¯ä»¥ä¿ç•™ã€‚
    */
    const reportStructure = [
        { id: '1', name: '1. äº”Då ±è¡¨', sign: 1, type: 'input', level: 0, defaultNote: '1ã€ç³»çµ±ä»Šæ—¥æ‰€æœ‰ã€Œ<span style="color:red;">éŠ·å¸³</span>ã€ã€‚<br>2ã€æ­£å¸¸æ°´è²»ã€å…¶ä»–è²»æ¬¾æ”¶è²»ç­‰ç­‰ã€‚' },
        
        // ä¿®æ”¹ï¼šCard 4 é–å®š
        { id: '2', name: '2. å¡4', sign: -1, type: 'summary', level: 0 ,defaultNote: '1ã€è‡ªå‹•åŠ ç¸½ï¼šå¼·åˆ¶é‚„åŸ + ç™¼ç¥¨æŠ˜è®“'},
        { id: '2.1', name: '2.1 å¼·åˆ¶é‚„åŸ', sign: -1, type: 'input', level: 1 },
        { id: '2.2', name: '2.2 ç™¼ç¥¨æŠ˜è®“', sign: -1, type: 'input', level: 1 },
        
        // ä¿®æ”¹ï¼šä¿è­‰é‡‘ é–å®š
        { id: '3', name: '3. ä¿è­‰é‡‘', sign: -1, type: 'summary', level: 0, defaultNote: '1ã€è‡ªå‹•åŠ ç¸½ï¼šè‡¨æ™‚ç”¨æ°´ + å»¶ç®¡å·¥ç¨‹' },
        { id: '3.1', name: '3.1 è‡¨æ™‚ç”¨æ°´ä¿è­‰é‡‘', sign: -1, type: 'input', level: 1 },
        { id: '3.2', name: '3.2 å»¶ç®¡å·¥ç¨‹ä¿è­‰é‡‘', sign: -1, type: 'input', level: 1 },
        
        { id: '4', name: '4. å­˜ç°¿åˆ©æ¯æ”¶å…¥', sign: 1, type: 'input', level: 0 },
        
        { id: '5', name: '5. æœ¬æ—¥æ‡‰å…¥å¸³é‡‘é¡', sign: 0, type: 'calc', level: 0, defaultNote: 'æ ¸å°OK' }, 
        
        { id: '6', name: '6. çµ±ä¸€å½™ç¹³', sign: -1, type: 'input', level: 0 ,defaultNote: '1ã€<span style="color:blue; font-weight:bold;">éŠ€è¡Œ</span>åŒ¯éŒ¢åˆ°<span style="color:red; font-weight:bold;">ã€ç¸½è™•ã€‘</span>ï¼ŒéŒ¢ä¸åœ¨ã€å» æ‰€ã€‘ã€‚<br>2ã€ä»£ç¹³è‡ªå‹•<span style="color:red; font-weight:bold;">ã€å…¥å¸³ã€‘</span>ã€‚'},
        
        { id: '7', name: '7. åª’é«”ä»£ç¹³', sign: -1, type: 'input', level: 0, 
          defaultNote: '1ã€<span style="color:blue; font-weight:bold;">éŠ€è¡Œ</span>åŒ¯éŒ¢åˆ°<span style="color:red; font-weight:bold;">ã€å€è™•ã€‘</span>ï¼ŒéŒ¢ä¸åœ¨ã€å» æ‰€ã€‘ã€‚<br>2ã€ä»£ç¹³è‡ªå‹•<span style="color:red; font-weight:bold;">ã€å…¥å¸³ã€‘</span>ã€‚' },
        
        { id: '8', name: '8. åª’é«”ä»£æ”¶', sign: -1, type: 'input', level: 0, 
          defaultNote: '1ã€<span style="color:blue; font-weight:bold;">éŠ€è¡Œ</span>åŒ¯éŒ¢åˆ°<span style="color:red; font-weight:bold;">ã€å€è™•ã€‘</span>ï¼ŒéŒ¢ä¸åœ¨ã€å» æ‰€ã€‘ã€‚<br>2ã€ä»£æ”¶è‡ªå‹•<span style="color:red; font-weight:bold;">ã€å…¥å¸³ã€‘</span>ã€‚' },
        { id: '9', name: '9. ä¿¡ç”¨å¡ç¹³è²»å¹³å°', sign: -1, type: 'input', level: 0 , 
          defaultNote: '1ã€<span style="color:blue; font-weight:bold;">éŠ€è¡Œ</span>åŒ¯éŒ¢åˆ°<span style="color:red; font-weight:bold;">ã€å€è™•ã€‘</span>ï¼ŒéŒ¢ä¸åœ¨ã€å» æ‰€ã€‘ã€‚<br>2ã€ç”¨æˆ¶<span style="color:blue;">ç·šä¸Š</span>åˆ·å¡<span style="color:red; font-weight:bold;">é€éå®˜ç¶²(1000å…ƒä»¥ä¸‹)orå°æ°´APP</span>ã€‚<br>3ã€å¯ä»¥ç•¶ä½œä»£æ”¶çš„ä¸€ç¨®ã€‚'},
        { id: '10_up', name: '10. éåª’é«”ä»£æ”¶ç¹³å…¥å€è™•', sign: -1, type: 'input', level: 0 },
        { id: '11', name: '11. æ‰‹çºŒè²»', sign: -1, type: 'input', level: 0, defaultNote: '1ã€(å°æ‰€)è¾²æœƒåŒ¯æ¬¾å€è™•çš„ã€ŒåŒ¯è²»ã€ã€‚<br>2ã€ç›®å‰ä¸€æ‰€ä¸€æ¬¡<span style="color:blue; font-weight:bold;">30å…ƒ</span><br>3ã€ä¸€ç¨®æˆæœ¬(cost)ã€‚' },
        
        { id: '12', name: '12. åŒ¯æ¬¾ç¹³è²»å…¥å€è™•', sign: -1, type: 'input', level: 0 ,
          defaultNote: '1ã€<span style="color:red;">ã€äººå·¥éŠ·å¸³ã€‘</span>ã€‚<br>2ã€éŒ¢ä¾†è‡ª<span style="color:blue;">ã€ä¸€å€ã€‘åˆåº«15151</span>ã€‚<br>3ã€ç‰¹æ®Š<span style="color:red;">VIP</span>(ä¸‰ç¸½é†«é™¢)æˆ–<span style="color:red;">ã€ç•°å¸¸å ±è¡¨ã€‘</span>éœ€äººå·¥è™•ç†<br>4ã€5000å…ƒå‚¬æ”¶ï¼Œå€Ÿç”¨15151äººå·¥éŠ·å¸³'},
        
        { id: '13_up', name: '13. åŒ¯æ¬¾ç¹³è²»å…¥æœ¬æ‰€', sign: -1, type: 'input', level: 0 },
        
        { id: '14_local', name: '14. ä»–å€ä»£æ”¶ (æœ¬å€)', sign: -1, type: 'input', level: 0,defaultNote:'1ã€ã€1å€çš„æ‰€ã€‘æ”¶ã€1å€çš„æ‰€ã€‘ã€‚<br><del>2ã€å…¨å®¶éƒ½æ˜¯æˆ‘å®¶ã€‚</del>' },
        { id: '14_other', name: '14. ä»–å€ä»£æ”¶ (ä»–å€)', sign: -1, type: 'input', level: 1 , 
          defaultNote: 'éŒ¢åœ¨<span style="background-color:#fffacd; padding:0 2px;">ã€ä½ å®¶ã€‘=ã€åˆ¥å€ã€‘</span>'},
        
        { id: '15_local', name: '15. ä»£æ”¶ä»–å€ (æœ¬å€)', sign: 1, type: 'input', level: 0 ,defaultNote:'1ã€ã€1å€çš„æ‰€ã€‘æ”¶ã€1å€çš„æ‰€ã€‘ã€‚<br><del>2ã€å…¨å®¶éƒ½æ˜¯æˆ‘å®¶ã€‚</del>'},
        { id: '15_other', name: '15. ä»£æ”¶ä»–å€ (ä»–å€)', sign: 1, type: 'input', level: 1, defaultNote: 'éŒ¢åœ¨<span style="background-color:#fffacd; padding:0 2px;">ã€æˆ‘å®¶ã€‘=ã€1å€ã€‘</span>}' },
        
        { id: '16', name: '16. æœ¬æœˆé æ”¶æ¬¡æœˆæ°´è²»', sign: 1, type: 'input', level: 0 ,defaultNote:'1ã€ä¸‹å€‹æœˆçš„æ°´å–®ï¼Œä½†ç”¨æˆ¶å·²å…ˆç¹³ã€‚<br>2ã€ç™¼ç”Ÿåœ¨æœˆåº•ï¼Œå·²æœ‰è¨ˆè²»è³‡æ–™ï¼Œè¡Œå‹•æ”¯ä»˜ç­‰å·²å¯ç¹³è²»ã€‚ä½†25ç•«é¢é‚„æ²’å‡ºä¾†ã€‚<br>3.å°è±¡ä¹ŸåŒ…å«<span style="color:red;">3C4</span>è·¨å€ç¹³è²»ã€‚'},
        { id: '17', name: '17. æœ¬æœˆæ‰£æŠµä¸Šæœˆé æ”¶', sign: -1, type: 'input', level: 0,defaultNote:'ä¸Šå€‹æœˆçš„<span style="color:red;">16æ¬„</span>' },
        { id: '28.1', name: '28.1 ä¿¡ç”¨å¡é€€è²¨(é‚„åŸ)', sign: 1, type: 'input', level: 0 ,defaultNote:'1ã€å» æ‰€<span style="color:blue; font-weight:bold;">ã€è‡¨æ«ƒã€‘</span>åˆ·å¡çš„ã€Œé€€åˆ·ã€<br>2ã€è«‹ç›¡é‡<span style="color:red;">ç•¶æ—¥</span>é€€åˆ·oré€€ç¾é‡‘ã€‚<br>3ã€ä¸»è¦æ˜¯æ‰‹çºŒè²»é›£æï¼Œæœƒé€ æˆé˜¿è°·çš„å›°æ“¾ã€‚'},

        { id: '18', name: '18. æœ¬æ—¥æ«ƒå°æ‡‰ç¹³é‡‘é¡', sign: 0, type: 'calc', level: 0 },

        { id: '10_down', name: '10. éåª’é«”ä»£æ”¶ç¹³å…¥æœ¬æ‰€', sign: -1, type: 'input', level: 0 },
        { id: '13_down', name: '13. åŒ¯æ¬¾ç¹³è²»å…¥æœ¬æ‰€(+)', sign: 1, type: 'input', level: 0 },
        { id: '19', name: '19. ä»–æ‰€ä»£æ”¶åŒ¯æ¬¾å…¥æœ¬æ‰€', sign: 1, type: 'input', level: 0 },
        { id: '28_down', name: '28. è‡¨æ«ƒä¿¡ç”¨å¡åŒ¯å…¥å€è™•', sign: -1, type: 'input', level: 0 , defaultNote: '1ã€å» æ‰€<span style="color:red;">ã€è‡¨æ«ƒã€‘</span>åˆ·å¡ã€‚<br>2ã€è¯å¡ä¸­å¿ƒæ˜æ—¥æœƒåŒ¯éŒ¢(=å€è™•15151)ã€‚<br>3ã€å› ç‚ºå» æ‰€<span style="color:red;">æ²’æœ‰æ‹¿åˆ°ã€Œç¾é‡‘ã€</span>ï¼Œæ•…ç‚ºã€è² é …ã€‘'},

        { id: '20', name: '20. æœ¬æ‰€æ‡‰åŒ¯æ¬¾é‡‘é¡', sign: 0, type: 'calc', level: 0 },

        { id: '21', name: '21. æ”¯ç¥¨å·²å…Œé‡‘é¡', sign: 1, type: 'input', level: 0 },
        { id: '22', name: '22. æ”¯ç¥¨æœªå…Œé‡‘é¡', sign: -1, type: 'input', level: 0 },

        { id: '23', name: '23. æœ¬æ—¥åŒ¯æ¬¾å–®åˆè¨ˆ', sign: 0, type: 'calc', level: 0, 
          defaultNote: 'ã€â˜…é‡è¦ã€‘<span style="color:red; font-weight:bold;">1ã€å» æ‰€éœ€è¦è§£ç¹³</span>(=åŒ¯åˆ°å€è™•15151)çš„éŒ¢ã€‚<br>2ã€çµ‚æ¥µç›®æ¨™ã€‚' }
    ];

    const defaultBoxData = [
        { categoryId: '1', name: 'è‡¨æ«ƒæ”¶é‡‘', amount: 12000 },
        { categoryId: '1', name: 'ä»£æ”¶ç¹³è‡ªå‹•éŠ·å¸³', amount: 3500 },
        { categoryId: '1', name: 'HYè‡ªå‹•éŠ·å¸³', amount: 800 },
        { categoryId: '1', name: 'ä»Šæ—¥ç”¨æˆ¶æ«ƒå°ä¿¡ç”¨å¡åˆ·å¡', amount: 1000 },
        { categoryId: '7', name: 'ä»£æ”¶ç¹³è‡ªå‹•å…¥å¸³', amount: 3500 },
        { categoryId: '7', name: 'HYè‡ªå‹•éŠ·å¸³', amount: 800 },
        { categoryId: '28_down', name: 'ä»Šæ—¥ç”¨æˆ¶åˆ·å¡', amount: 1000 }
    ];

    let itemTotals = {}; 
    let itemBoxes = {};

    function init() {
        const tbody = document.getElementById('tableBody');
        const select = document.getElementById('inputCategory');
        tbody.innerHTML = '';
        select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é …ç›®...</option>';

        itemBoxes = {};
        reportStructure.forEach(item => {
            itemTotals[item.id] = 0;
            itemBoxes[item.id] = [];
        });

        defaultBoxData.forEach(data => {
            itemBoxes[data.categoryId].push({
                id: Date.now() + Math.random(), 
                name: data.name,
                amount: data.amount
            });
        });

        reportStructure.forEach(item => {
            const tr = document.createElement('tr');
            
            // æ¨£å¼åˆ¤æ–·
            if(item.type === 'calc') tr.classList.add('result-row');
            
            // [æ–°å¢] ç‚º 2å’Œ3 æ·»åŠ é–å®šæ¨£å¼
            if(item.id === '2' || item.id === '3') {
                tr.classList.add('row-locked');
            }
            // [æ–°å¢] ç‚º 14_local å’Œ 15_local æ·»åŠ é«˜äº®æ¨£å¼
            if(item.id === '14_local' || item.id === '15_local') {
                tr.classList.add('row-highlight');
            }

            let nameHtml = `<div class="${item.level === 1 ? 'indent-1' : ''} ${item.level === 2 ? 'indent-2' : ''}">${item.name}</div>`;
            if (item.sign === 1) nameHtml += ` <span class="sign-plus">(+)</span>`;
            if (item.sign === -1) nameHtml += ` <span class="sign-minus">(-)</span>`;
            
            let boxHtml = '';
            // åªæœ‰ type ç‚º 'input' æ‰ç”¢ç”Ÿæ‹–æ‹‰å€ï¼Œsummary å’Œ calc éƒ½ä¸ç”¢ç”Ÿ
            if (item.type === 'input') {
                boxHtml = `<div class="box-container" id="box-container-${item.id}" 
                            ondragover="allowDrop(event)" 
                            ondragleave="leaveDrop(event)"
                            ondrop="drop(event, '${item.id}')"></div>`;
            } else {
                // é–å®šå€æˆ–è¨ˆç®—å€é¡¯ç¤ºç©ºç™½æˆ–æç¤º
                boxHtml = `<div style="color:#ccc; font-size:12px; font-style:italic; min-height:40px; line-height:40px;">${item.type==='summary'?'(è‡ªå‹•è¨ˆç®—)':''}</div>`;
            }

            let amountHtml = `<div id="amount-${item.id}" class="amount-cell">0</div>`;
            const defaultText = item.defaultNote ? item.defaultNote : '';
            let noteHtml = `<div class="note-input" contenteditable="true" placeholder="...">${defaultText}</div>`;

            tr.innerHTML = `
                <td class="item-name">${nameHtml}</td>
                <td>${boxHtml}</td>
                <td>${amountHtml}</td>
                <td>${noteHtml}</td>
            `;
            tbody.appendChild(tr);

            // åªæœ‰ 'input' é¡å‹æ‰åŠ å…¥ä¸‹æ‹‰é¸å–®ï¼Œé€™æ¨£å°±ç„¡æ³•é¸åˆ° 2 å’Œ 3
            if(item.type === 'input') {
                const option = document.createElement('option');
                option.value = item.id;
                option.text = item.name + (item.sign === 1 ? ' (+)' : ' (-)');
                select.appendChild(option);
            }
        });

        Object.keys(itemBoxes).forEach(id => renderBoxes(id));
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const fab = document.getElementById('fabBtn');
        const fabLabel = document.getElementById('fabLabel');
        
        const isActive = sidebar.classList.contains('active');
        
        if(isActive) {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            fab.classList.add('hint-pulse');
            fabLabel.style.display = 'block';
        } else {
            sidebar.classList.add('active');
            overlay.classList.add('active');
            fab.classList.remove('hint-pulse');
            fabLabel.style.display = 'none';
        }
    }

    function addBox() {
        const name = document.getElementById('inputName').value;
        const amount = parseFloat(document.getElementById('inputAmount').value);
        const categoryId = document.getElementById('inputCategory').value;

        if (!name || isNaN(amount) || !categoryId) {
            alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');
            return;
        }

        itemBoxes[categoryId].push({ 
            id: Date.now(), 
            name, 
            amount 
        });

        renderBoxes(categoryId);
        calculate();
        
        const fab = document.getElementById('fabBtn');
        fab.innerHTML = 'âœ…';
        setTimeout(() => fab.innerHTML = 'ğŸ› ï¸<div class="fab-label" id="fabLabel" style="display:none">é»æˆ‘æ–°å¢é …ç›®</div>', 1500);

        document.getElementById('inputName').value = '';
        document.getElementById('inputAmount').value = '';
    }

    function removeBox(categoryId, boxId) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é‡‘é¡æ–¹æ¡†å—ï¼Ÿ')) return;
        
        itemBoxes[categoryId] = itemBoxes[categoryId].filter(b => b.id !== boxId);
        renderBoxes(categoryId);
        calculate();
    }

    function drag(ev, categoryId, boxId) {
        const data = JSON.stringify({ sourceCategory: categoryId, boxId: boxId });
        ev.dataTransfer.setData("text", data);
        ev.dataTransfer.effectAllowed = "move";
    }

    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    function leaveDrop(ev) {
        ev.currentTarget.classList.remove('drag-over');
    }

    function drop(ev, targetCategory) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');

        const dataStr = ev.dataTransfer.getData("text");
        if (!dataStr) return;
        
        const data = JSON.parse(dataStr);
        const sourceCategory = data.sourceCategory;
        const boxId = data.boxId;

        if (sourceCategory === targetCategory) return;

        const boxIndex = itemBoxes[sourceCategory].findIndex(b => b.id === boxId);
        if (boxIndex === -1) return;
        const boxData = itemBoxes[sourceCategory][boxIndex];

        itemBoxes[sourceCategory].splice(boxIndex, 1);
        itemBoxes[targetCategory].push(boxData);

        renderBoxes(sourceCategory);
        renderBoxes(targetCategory);
        calculate();
    }

    function renderBoxes(id) {
        const container = document.getElementById(`box-container-${id}`);
        // å¦‚æœæ˜¯ summary é¡å‹ (å¦‚ 2, 3) æ²’æœ‰ box-containerï¼Œç›´æ¥ return
        if(!container) return;
        
        container.innerHTML = '';
        
        const itemData = reportStructure.find(i => i.id === id);
        const isNegative = itemData && itemData.sign === -1;

        let sum = 0;
        itemBoxes[id].forEach((box) => {
            sum += box.amount;
            const boxEl = document.createElement('div');
            
            boxEl.className = `data-box ${isNegative ? 'minus' : ''}`;
            boxEl.draggable = true;
            boxEl.ondragstart = (event) => drag(event, id, box.id);
            
            boxEl.innerHTML = `
                ${box.name}: ${box.amount}
                <span class="remove-btn" onclick="removeBox('${id}', ${box.id})">Ã—</span>
            `;
            container.appendChild(boxEl);
        });

        itemTotals[id] = sum;
        
        const sign = itemData.sign;
        const amountEl = document.getElementById(`amount-${id}`);
        amountEl.innerText = (sum * sign);
        amountEl.style.color = sign === 1 ? 'var(--plus-color)' : 'var(--minus-color)';
    }

    function calculate() {
        const val = (id) => {
            const item = reportStructure.find(i => i.id === id);
            if (!item) return 0;
            if (item.type === 'calc' || item.type === 'summary') return itemTotals[id] || 0;
            return (itemTotals[id] || 0) * item.sign;
        };
        
        // [æ–°å¢åŠŸèƒ½] è‡ªå‹•è¨ˆç®— 2 å’Œ 3 çš„ç¸½å’Œ
        // 2 = 2.1 + 2.2
        // å› ç‚º 2.1, 2.2 æ˜¯ inputï¼Œval() å›å‚³çš„æ˜¯ (é‡‘é¡ * -1)
        // æˆ‘å€‘éœ€è¦çš„æ˜¯ç¸½é‡(è² å€¼)ï¼Œæ‰€ä»¥ç›´æ¥ç›¸åŠ  val å³å¯
        let sum2 = val('2.1') + val('2.2');
        itemTotals['2'] = sum2; // å­˜èµ·ä¾†æ–¹ä¾¿å¾ŒçºŒå–ç”¨
        updateResultRow('2', sum2);

        // 3 = 3.1 + 3.2
        let sum3 = val('3.1') + val('3.2');
        itemTotals['3'] = sum3;
        updateResultRow('3', sum3);


        // [ä¿®æ”¹] è¨ˆç®—ç¬¬ 5 é …
        // æ³¨æ„ï¼šåŸæœ¬å…¬å¼æ˜¯ val('1') + val('2') + ...
        // ä½†ç¾åœ¨ val('2') = val('2.1') + val('2.2')
        // å¦‚æœæˆ‘å€‘å¯« val('1') + val('2') + val('2.1') + val('2.2') æœƒé‡è¤‡è¨ˆç®—ï¼
        // è§£æ±ºæ–¹æ³•ï¼šå…¬å¼åªåŠ ç¸½ã€Œç´°é …ã€(2.1, 2.2)ï¼Œä¸åŠ ç¸½ã€Œæ¯é …ã€(2)ã€‚
        let total5 = val('1') + 
                     val('2.1') + val('2.2') +  // ä¸åŠ  val('2')
                     val('3.1') + val('3.2') +  // ä¸åŠ  val('3')
                     val('4');
                     
        updateResultRow('5', total5);

        let adjustTo18 = 
            val('6') + val('7') + val('8') + val('9') + val('10_up') + 
            val('11') + val('12') + val('13_up') + val('14_local') + val('14_other') + 
            val('15_local') + val('15_other') + val('16') + val('17') + val('28.1');
        let total18 = total5 + adjustTo18;
        updateResultRow('18', total18);

        let adjustTo20 = val('10_down') + val('13_down') + val('19') + val('28_down');
        let total20 = total18 + adjustTo20;
        updateResultRow('20', total20);

        let total23 = total20 + val('21') + val('22');
        updateResultRow('23', total23);
    }

    function updateResultRow(id, value) {
        // å¦‚æœæ˜¯ type='summary' ä¸” sign=-1ï¼Œå‚³å…¥çš„ value å·²ç¶“æ˜¯è² æ•¸ï¼Œé€™è£¡åªæ˜¯è² è²¬é¡¯ç¤ºé¡è‰²
        // æˆ‘å€‘çµ±ä¸€å°‡æ•¸å€¼å­˜åœ¨ itemTotals[id] ä¸­ (å°æ–¼ calc/summary é¡å‹ï¼Œæˆ‘å€‘å­˜çš„æ˜¯çµæœå€¼)
        if(!itemTotals[id]) itemTotals[id] = value;

        const el = document.getElementById(`amount-${id}`);
        if(el) {
            el.innerText = value;
            // è² æ•¸é¡¯ç¤ºç´…è‰²ï¼Œæ­£æ•¸é¡¯ç¤ºè—è‰² (æˆ–ä¾æ“šæ‚¨çš„ sign å®šç¾©)
            // é€™è£¡ç°¡å–®ç”¨æ•¸å€¼æ­£è² åˆ¤æ–·
            if(value > 0) el.style.color = 'blue';
            else if(value < 0) el.style.color = 'red';
            else el.style.color = 'black';
        }
    }

    function resetAll() {
        if(confirm('ç¢ºå®šè¦æ¢å¾©æˆé è¨­ç‹€æ…‹å—ï¼Ÿ(æ–°å¢çš„è³‡æ–™æœƒæ¶ˆå¤±)')) {
            init();
            calculate();
            toggleSidebar();
        }
    }

    init();
    calculate();
</script>
</body>
  <footer class="footer">
    <div class="footer-content">
      <p>Â© 2025 ALL RIGHTS RESERVED.</p>
      <p>This page was created by é˜¿è°·. (Made by é˜¿è°·. Not maintained.)</p>
    </div>
  </footer>
</html>
